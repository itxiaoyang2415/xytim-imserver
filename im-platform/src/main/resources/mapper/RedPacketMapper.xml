<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bx.implatform.mapper.RedPacketMapper">

    <!-- 扣减红包剩余金额和个数 -->
    <update id="deductRedPacket">
        UPDATE t_red_packet
        SET remaining_amount = remaining_amount - #{amount},
            remaining_count = remaining_count - 1,
            updated_at = NOW()
        WHERE id = #{packetId}
          AND remaining_count > 0
          AND remaining_amount >= #{amount}
          AND status = 2
    </update>

</mapper>
