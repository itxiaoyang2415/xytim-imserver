# 转账领取功能 - 前端对接文档

## 📢 重要变更说明

**⚠️ 转账功能已从"立即到账"改为"需要领取"模式，类似微信转账！**

### 变更对比

| 项目 | 旧版本（立即到账） | 新版本（需要领取） |
|------|-------------------|-------------------|
| 发送时 | 直接完成转账 | 只冻结金额，等待领取 |
| 接收时 | 自动到账 | **需要点击领取** |
| 过期机制 | 无 | **24小时未领取自动退款** |
| 消息内容 | 存储交易流水号(TXN开头) | **存储转账编号(TXF开头)** |
| 状态 | 只有成功/失败 | 待领取/已领取/已过期/已退款 |

---

## 🔄 转账完整流程

```
用户A发送转账
    ↓
冻结用户A的余额
    ↓
创建转账记录（状态：待领取）
    ↓
推送IM消息给用户B
    ↓
用户B收到消息，显示"领取转账"按钮
    ↓
┌─────────────────┴─────────────────┐
│                                   │
↓ 24小时内点击领取                  ↓ 24小时未领取
│                                   │
解冻A的余额并扣款                   解冻A的余额（退回）
增加B的余额                         转账状态变为"已退款"
转账状态变为"已领取"
```

---

## 📡 API 接口变更

### 1. 发送转账（已修改 ⚠️）

**接口**：`POST /transfer/send`

**请求参数**：
```json
{
  "toUserId": 4,           // 收款用户ID
  "amount": 100.00,        // 转账金额
  "remark": "请收款",      // 转账备注（可选）
  "payPassword": "123456"  // 支付密码
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "transferNo": "TXF1728345678ABCD1234",    // ⭐ 转账编号（新增）
    "transactionNo": null,                    // ⚠️ 暂无交易流水号（领取后才有）
    "fromUserId": 3,                          // 发送方用户ID
    "toUserId": 4,                            // 接收方用户ID
    "amount": 100.00,                         // 转账金额
    "status": 1,                              // ⭐ 状态：1-待领取
    "statusDesc": "待领取",                   // ⭐ 状态描述
    "remark": "请收款",                       // 转账备注
    "transferTime": 1728345678000,            // 转账时间（13位时间戳）
    "expireTime": 1728431878000,              // ⭐ 过期时间（24小时后，13位时间戳）
    "receiveTime": null,                      // 领取时间（未领取为null）
    "refundTime": null                        // 退款时间（未退款为null）
  }
}
```

**变更点**：
- ✅ 发送成功后，金额被冻结，不立即到账
- ✅ 返回 `transferNo`（转账编号）而不是 `transactionNo`
- ✅ 返回 `status` 和 `expireTime`

---

### 2. 领取转账（⭐ 新增接口）

**接口**：`POST /transfer/receive`

**请求参数**：
```json
{
  "transferNo": "TXF1728345678ABCD1234"  // 转账编号（从消息中获取）
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "transferNo": "TXF1728345678ABCD1234",    // 转账编号
    "transactionNo": "TXN1728345680001",      // ⭐ 交易流水号（领取后生成）
    "fromUserId": 3,
    "toUserId": 4,
    "amount": 100.00,
    "status": 2,                               // ⭐ 状态：2-已领取
    "statusDesc": "已领取",
    "beforeBalance": 900.00,                   // 领取前余额
    "afterBalance": 1000.00,                   // 领取后余额
    "remark": "请收款",
    "transferTime": 1728345678000,
    "expireTime": 1728431878000,
    "receiveTime": 1728345680000,              // ⭐ 领取时间
    "refundTime": null
  }
}
```

**错误响应示例**：
```json
// 已被领取
{
  "code": 500,
  "message": "转账已被领取",
  "data": null
}

// 已过期
{
  "code": 500,
  "message": "转账已过期",
  "data": null
}

// 无权领取
{
  "code": 500,
  "message": "无权领取该转账",
  "data": null
}
```

---

### 3. 查询转账详情（⚠️ 已修改）

**接口**：`GET /transfer/detail/{transferNo}`

**注意**：参数从 `transactionNo`（交易流水号）改为 `transferNo`（转账编号）！

**响应数据**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "transferNo": "TXF1728345678ABCD1234",
    "transactionNo": "TXN1728345680001",     // 已领取才有值
    "fromUserId": 3,
    "toUserId": 4,
    "amount": 100.00,
    "status": 2,                              // 状态码
    "statusDesc": "已领取",                   // 状态描述
    "remark": "请收款",
    "transferTime": 1728345678000,
    "expireTime": 1728431878000,
    "receiveTime": 1728345680000,
    "refundTime": null
  }
}
```

---

## 📨 IM 消息格式变更

### 转账消息结构

**消息类型**：`type = 8`（MessageType.TRANSFER）

**⚠️ 重要变更**：`content` 字段存储的是 `transferNo`（转账编号），不再是 `transactionNo`（交易流水号）！

```json
{
  "id": 15,
  "sendId": 3,                              // 发送方用户ID
  "recvId": 4,                              // 接收方用户ID
  "content": "TXF1728345678ABCD1234",       // ⚠️ 转账编号（TXF开头）
  "type": 8,                                // 消息类型：8-转账
  "status": 0,
  "sendTime": 1728345678000
}
```

---

## 🎨 前端实现建议

### 1. 消息列表展示

```javascript
// 判断是否是转账消息
if (message.type === 8) {
  const transferNo = message.content; // 转账编号
  
  // 调用详情接口获取转账状态
  const detail = await fetch(`/api/transfer/detail/${transferNo}`);
  
  // 根据状态显示不同UI
  switch (detail.status) {
    case 1: // 待领取
      return `<div class="transfer-message">
        <span>转账 ¥${detail.amount}</span>
        ${isReceiver ? '<button>领取转账</button>' : '<span>待对方领取</span>'}
      </div>`;
      
    case 2: // 已领取
      return `<div class="transfer-message received">
        <span>转账 ¥${detail.amount}</span>
        <span>已领取</span>
      </div>`;
      
    case 3: // 已过期
      return `<div class="transfer-message expired">
        <span>转账 ¥${detail.amount}</span>
        <span>已过期退款</span>
      </div>`;
      
    case 4: // 已退款
      return `<div class="transfer-message refunded">
        <span>转账 ¥${detail.amount}</span>
        <span>已退款</span>
      </div>`;
  }
}
```

### 2. 点击转账消息

```javascript
// 点击转账消息
async function onTransferMessageClick(message) {
  const transferNo = message.content;
  
  // 1. 获取转账详情
  const detail = await getTransferDetail(transferNo);
  
  // 2. 显示转账详情弹窗
  showTransferDetailDialog({
    amount: detail.amount,
    remark: detail.remark,
    fromUser: getUserInfo(detail.fromUserId),
    toUser: getUserInfo(detail.toUserId),
    status: detail.status,
    statusDesc: detail.statusDesc,
    transferTime: formatTime(detail.transferTime),
    expireTime: formatTime(detail.expireTime),
    receiveTime: detail.receiveTime ? formatTime(detail.receiveTime) : null,
    
    // 是否显示"领取"按钮
    canReceive: detail.status === 1 && detail.toUserId === currentUserId,
    
    // 领取回调
    onReceive: () => receiveTransfer(transferNo)
  });
}
```

### 3. 领取转账

```javascript
async function receiveTransfer(transferNo) {
  try {
    const result = await fetch('/api/transfer/receive', {
      method: 'POST',
      body: JSON.stringify({ transferNo })
    });
    
    if (result.code === 200) {
      // 领取成功
      showToast('领取成功！');
      
      // 刷新余额
      await refreshBalance();
      
      // 更新消息状态
      updateMessageStatus(transferNo, 2); // 已领取
      
      // 关闭弹窗
      closeDialog();
    } else {
      // 领取失败
      showToast(result.message);
    }
  } catch (error) {
    showToast('领取失败，请重试');
  }
}
```

### 4. 发送转账

```javascript
async function sendTransfer(toUserId, amount, remark, payPassword) {
  try {
    const result = await fetch('/api/transfer/send', {
      method: 'POST',
      body: JSON.stringify({
        toUserId,
        amount,
        remark,
        payPassword
      })
    });
    
    if (result.code === 200) {
      const transfer = result.data;
      
      showToast('转账发送成功，等待对方领取');
      
      // ⚠️ 注意：发送成功后，余额会被冻结
      // 需要刷新余额显示
      await refreshBalance();
      
      // 转账消息会通过WebSocket推送，无需手动添加
      // 但如果需要立即显示，可以手动插入消息列表
      addMessageToList({
        type: 8,
        content: transfer.transferNo, // ⚠️ 存储转账编号
        sendTime: transfer.transferTime,
        status: transfer.status
      });
    } else {
      showToast(result.message);
    }
  } catch (error) {
    showToast('转账失败，请重试');
  }
}
```

---

## 📊 状态码说明

| 状态码 | 状态描述 | 说明 | UI展示建议 |
|-------|---------|------|-----------|
| 1 | 待领取 | 已发送，等待对方领取 | 接收方显示"领取"按钮；发送方显示"待领取" |
| 2 | 已领取 | 已成功领取 | 显示"已领取"，灰色样式 |
| 3 | 已过期 | 超过24小时未领取，已退款 | 显示"已过期退款" |
| 4 | 已退款 | 手动或自动退款 | 显示"已退款" |

---

## ⏰ 时间字段说明

所有时间字段均为 **13位Unix时间戳（毫秒）**

| 字段 | 说明 | 示例 |
|------|------|------|
| transferTime | 转账发送时间 | 1728345678000 |
| expireTime | 过期时间（发送后24小时） | 1728431878000 |
| receiveTime | 领取时间（未领取为null） | 1728345680000 |
| refundTime | 退款时间（未退款为null） | 1728431878000 |

**JavaScript时间转换示例**：
```javascript
// 时间戳转日期字符串
function formatTime(timestamp) {
  if (!timestamp) return '-';
  const date = new Date(timestamp);
  return date.toLocaleString('zh-CN');
}

// 判断是否过期
function isExpired(expireTime) {
  return Date.now() > expireTime;
}

// 计算剩余时间
function getRemainTime(expireTime) {
  const remain = expireTime - Date.now();
  if (remain <= 0) return '已过期';
  
  const hours = Math.floor(remain / (1000 * 60 * 60));
  const minutes = Math.floor((remain % (1000 * 60 * 60)) / (1000 * 60));
  return `剩余 ${hours}小时${minutes}分钟`;
}
```

---

## 🎯 前端需要修改的地方

### ✅ 必须修改

1. **转账消息解析逻辑**
   - 从 `message.content` 获取的是 `transferNo`（TXF开头），不再是 `transactionNo`（TXN开头）
   - 需要调用 `/transfer/detail/{transferNo}` 接口获取详情

2. **转账详情接口调用**
   - 接口路径从 `/transfer/detail/{transactionNo}` 改为 `/transfer/detail/{transferNo}`
   - 参数类型变化：交易流水号 → 转账编号

3. **新增"领取转账"功能**
   - 添加领取按钮（仅接收方、状态为待领取时显示）
   - 调用 `/transfer/receive` 接口
   - 处理领取成功/失败的反馈

4. **状态显示**
   - 根据 `status` 字段显示不同的UI状态
   - 添加过期倒计时（待领取状态时）

5. **发送转账后的提示**
   - 提示文案改为"转账发送成功，等待对方领取"
   - 余额显示需要同时显示"可用余额"和"冻结金额"（可选）

### 🔄 建议优化

1. **转账列表缓存**
   - 缓存已查询的转账详情，避免重复请求
   - 领取成功后更新缓存状态

2. **实时状态更新**
   - 使用定时器检查待领取转账的状态
   - 或通过WebSocket推送状态变更通知

3. **余额展示优化**
   - 在钱包页面区分显示"可用余额"和"冻结金额"
   ```javascript
   {
     "balance": 900.00,        // 可用余额
     "frozenBalance": 100.00,  // 冻结金额（待领取的转账）
     "totalBalance": 1000.00   // 总余额 = 可用 + 冻结
   }
   ```

---

## 🐛 常见问题

### Q1: 为什么转账消息的 content 变成了 TXF 开头？
**A**: 因为转账需要领取，所以 content 存储的是**转账编号**（transferNo），而不是**交易流水号**（transactionNo）。只有领取成功后才会生成交易流水号。

### Q2: 如何区分旧转账消息和新转账消息？
**A**: 通过 content 的前缀区分：
- `TXN` 开头：旧版本直接到账的转账（交易流水号）
- `TXF` 开头：新版本需要领取的转账（转账编号）

### Q3: 用户A发送转账后，余额立即减少吗？
**A**: 不会！用户A的余额会被**冻结**（frozen_balance），可用余额（balance）减少，但总余额不变。只有对方领取后，冻结金额才会真正扣除。

### Q4: 如果24小时没领取，钱会退回吗？
**A**: 会！系统每小时检查一次，自动将过期未领取的转账退款给发送方，状态变为"已退款"。

### Q5: 能否取消已发送的转账？
**A**: 当前版本不支持手动取消。只能等待24小时自动退款，或者对方领取。

---

## 📞 技术支持

如有疑问，请联系后端开发团队。

**更新日期**：2025-10-07  
**文档版本**：v1.0

